# Публикация поста

Публикация контента на платформе SAVVA — это трехступенчатый процесс, который обеспечивает целостность данных, децентрализацию и проверку в блокчейне. Процесс включает в себя подготовку данных поста локально, загрузку контента и его дескриптора в IPFS, а затем регистрацию поста в блокчейне через вызов смарт-контракта.

Фронтенд-редактор автоматизирует этот процесс через мастер, но понимание основных шагов имеет решающее значение для разработчиков.

---

## Шаг 1: Подготовка данных поста

Перед любой загрузкой или транзакцией редактор организует пост в стандартизированную структуру каталогов. Эта структура управляется локально с использованием API файловой системы.

Основные компоненты:

* Файл параметров (`params.json`) для настроек, специфичных для редактора.
* Файл дескриптора (`info.yaml`), который определяет структуру поста и метаданные для IPFS.
* Markdown файлы для контента на каждом языке.
* Директория `uploads/` для любых связанных медиафайлов (изображений, видео и т. д.).

### Пример `params.json`

Этот файл содержит настройки, используемые пользовательским интерфейсом редактора, и не публикуется в блокчейне.

```json
{
  "guid": "c4a7f6b9-6e3e-4b9e-8b1e-2e4a6d7c8b9a",
  "nsfw": false,
  "fundraiser": 0,
  "publishAsNewPost": true,
  "locales": {
    "en": {
      "tags": ["децентрализация", "социальные"],
      "categories": ["Технологии"],
      "chapters": [
        { "title": "Что такое блокчейн?" },
        { "title": "IPFS и адресация контента" }
      ]
    }
  },
  "thumbnail": "uploads/thumbnail.png"
}
```

### Пример `info.yaml` (Дескриптор поста)

Этот файл является каноническим определением поста и загружается в IPFS. Он связывает все части контента вместе.

```yaml
savva_spec_version: "2.0"
data_cid: bafybeih...
gateways:
  - https://ipfs.io/
locales:
  en:
    title: "Понимание децентрализованных систем"
    text_preview: "Глубокое погружение в основные концепции децентрализации..."
    data_path: "en/data.md"
    chapters:
      - data_path: "en/chapters/1.md"
      - data_path: "en/chapters/2.md"
```

* **data\_cid**: CID IPFS директории, содержащей весь Markdown контент и загруженные файлы.
* **locales**: Содержит метаданные, специфичные для языка. Заголовок и текст\_предварительный просмотр из редактора хранятся здесь.
* **data\_path / chapters.data\_path**: Относительные пути к файлам контента в директории `data_cid`.

---

## Шаг 2: Загрузка в IPFS

Процесс загрузки происходит в два отдельных этапа, которые обрабатываются API хранения на бэкенде.

1. **Загрузка директории контента**: Все файлы контента (например, `en/data.md`, `en/chapters/1.md`, `uploads/thumbnail.png`) загружаются как одна директория в IPFS. Бэкенд возвращает единственный CID IPFS для этой директории, который становится `data_cid`.
2. **Загрузка дескриптора**: Файл `info.yaml` генерируется с `data_cid` из предыдущего шага. Этот YAML файл затем загружается в IPFS как отдельный файл. CID этого файла `info.yaml` является окончательным указателем IPFS для поста.

---

## Шаг 3: Регистрация в блокчейне

Последний шаг — записать пост в блокчейн, вызвав функцию `reg` на смарт-контракте `ContentRegistry`.

Фронтенд выполняет эту транзакцию с следующими параметрами:

* **domain**: Текущее имя домена (например, `savva.app`).
* **author**: Адрес кошелька пользователя.
* **guid**: Уникальный идентификатор из `params.json`.
* **ipfs**: CID IPFS файла дескриптора `info.yaml` из Шага 2.
* **content\_type**: Строка `bytes32`, обычно `post` для нового контента или `post-edit` для обновлений.

### Пример вызова контракта

```javascript
// Из: src/components/editor/wizard_steps/StepPublish.jsx

const contract = await getSavvaContract(app, "ContentRegistry", { write: true });

const hash = await contract.write.reg([
  domain,           // "savva.app"
  user.address,     // "0x123..."
  guid,             // "c4a7f6b9-..."
  descriptorCid,    // "bafybeif..."
  toHexBytes32("post")
]);

// Интерфейс пользователя затем ждет подтверждения транзакции
const receipt = await publicClient.waitForTransactionReceipt({ hash });
```

После успешного завершения транзакции пост официально публикуется и появится в контентных лентах.