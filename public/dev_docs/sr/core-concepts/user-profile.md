# Уговор о корисничком профилу

Уговор `UserProfile` чува стање на ланцу које покреће странице аутора, имена и метаподатке профила у оквиру SAVVA домена. Комбинује глобални регистар људски читљивих имена са складиштењем кључ/вредност по домену и лаганим помоћним средствима за аватаре и контакт податке. Ова страница резимира како дАпликација комуницира са уговором и JSON објектима профила који се налазе поред њега на IPFS-у.

## Добијање инстанце уговора

Адреса уговора се добија из позадинског `/info` одговора под `savva_contracts.UserProfile`. Фронтенд код је резолује преко заједничког помоћног алата:

```js
const userProfile = await getSavvaContract(app, "UserProfile");
```

Сваки приказ и упис приказан доле користи тај помоћни алат заједно са алаткама за рутирање актера (погледај `ProfileEditPage.jsx` и `userProfileStore.js`).

## Регистрована имена

Имена су глобално јединствена, мала слова, регистрована директно на адресе новчаника.

- `names(address) → string` враћа тренутно име за адресу.
- `owners(string) → address` враћа име назад његовом власнику. Оба помоћна алата се користе приликом учитавања произвољног профила (погледај `fetchProfileForEdit`).

Мутације:

- `setName(string name)` региструје или ажурира позивни назив корисника. UI позива ово унутар `executeSetName()` приликом чувања измена профила.
- `removeName()` брише унос.
- `transferName(address to)` преноси резервацију на другу адресу.

Пошто су имена глобална, UI омогућава кориснику да изабере једну регистровану вредност, а затим изводи језички специфична приказна имена из офф-чаин JSON профила (описано доле).

## Аватари и друга примарна поља

Два самостална помоћна алата чувају најважнија поља на ланцу:

- `setAvatar(string cid)` / `avatars(address) → string` чувају и читају IPFS CID за аватар корисника. Уредник отпрема слику на позадински крајњи тачку за складиштење, а затим позива `setAvatar` са враћеним CID-ом.
- `setPubKey(string modifier, string pubKey)` опционално бележи пар кључева који се могу шифровати за функције директног слања порука.

Постоји и погодан `setAll(string name, string avatar, bytes32 domain, string profile)` који групише ажурирање имена + аватара заједно са профилним подацима за један домен.

## Складиштење кључ/вредност ограничено доменом

Већина метаподатака се чува коришћењем примитива `setString` и `setUInt`. Обе примају ид домена и кључ, кодиране као `bytes32`.

```js
await userProfile.write.setString([
  toHexBytes32(app.selectedDomainName()),
  toHexBytes32("profile_cid"),
  newProfileCid,
]);
```

Пример изнад одражава оно што `ProfileEditPage.jsx` ради након отпремања JSON профила на IPFS – CID се уписује под тренутним доменом и кључем `profile_cid`. Читања користе `getString`/`getUInt` са истим параметрима. Уговор такође излаже сирове јавне мапе (`profileString`, `profileUInt`) ако вам треба директан приступ без поновног израчунавања кључева.

### Уобичајени кључеви

| Кључ | Тип | Намена |
| --- | --- | --- |
| `profile_cid` | string | Указује на канонски JSON профил на IPFS-у за изабрани домен. |
| Прилагођени кључеви | string / uint | Интегратори могу увести додатне метаподатке за свој домен бирајући нове кључеве – само их држите испод 32 бајта пре кодирања. |

Пошто су подаци кључевиран по `(корисник, домен, кључ)`, различити SAVVA домени могу одржавати независне документе профила док и даље деле исти глобални регистар имена.

## JSON шема профила

JSON објекат који се чува под `profile_cid` покреће богати UI профила у `ProfilePage.jsx`. Када уредник профила сачува измене, емитује документ сличан следећем:

```json
{
  "display_names": {
    "en": "Alice Example",
    "fr": "Alice Exemple"
  },
  "about_me": {
    "en": "Writer focused on freedom of expression.",
    "es": "Escritora centrada en la libertad de expresión."
  },
  "nsfw": "h",
  "sponsor_values": [10, 25, 100],
  "links": [
    { "title": "Website", "url": "https://alice.example" },
    { "title": "Fedi", "url": "https://fedi.social/@alice" }
  ]
}
```

Кључна поља:

- `display_names` — језички специфични приказни називи јавног имена аутора. `ProfilePage` бира тренутни језик UI-а, враћа се на енглески, а затим на регистровано име на ланцу.
- `about_me` — биографски текст на више језика који се приказује на картици профила. Старији документи могу користити један низ `about`; UI се у складу с тим враћа.
- `nsfw` — ознака преференције (`h`, `s`, итд.) која утиче на то који се постови подразумевано приказују.
- `sponsor_values` — целобројни прагови (у SAVVA) који се користе за унапред попуњавање нивоа претплате.
- `links` — произвољни објекти спољних линкова (`title` + `url`).

Можете проширити документ додатним пољима по домену; кориснички код треба да игнорише кључеве које не препознаје.

## Читање профила у дАпликацији

`ProfilePage.jsx` оркестрира три извора:

1. Вебсокет позив (`get-user`) који враћа поља на ланцу као што су `address`, `name`, `display_names` кеширани од стране позадине, статистику улога и податке о претплати.
2. Директно преузимање са IPFS-а за CID који се чува под `profile_cid` користећи помоћне алате у `userProfileStore.js`.
3. Локалне измене из кеша `AppContext` (`userDisplayNames`) које омогућавају да се привремене измене одмах прикажу.

Комбиновани резултат одређује шта се приказује испод банера аутора, језички специфично име и све помоћне видгете као што су друштвени линкови.

## Резиме тока уређивања

Док уређују свој профил (`ProfileEditPage.jsx`):

1. UI резолује циљну адресу по имену (путем `owners(name)`), затим учитава CID аватара, тренутно име и `profile_cid`.
2. Ако постоји CID профила, JSON се преузима са IPFS-а и нормализује у стање уредника.
3. Чување отпрема нови JSON објекат, а затим издаје `setString(domain, "profile_cid", cid)` преко `sendAsActor`, осигуравајући да је трансакција потписана од стране налога који тренутно делује.
4. Помоћни алат `applyProfileEditResult` ажурира локалне кешеве тако да су нови подаци видљиви без чекања на реиндексирање позадине.

Пут отпремања аватара прати исти процес, позивајући `setAvatar` са враћеним CID-ом.

## Рад са именима у односу на приказна имена

- **Регистровано име (`setName`)** — јединствени идентификатор на нивоу ланца. Користи се за рутирање преко `/@handle` URL-ова и чува у мапи `names` уговора.
- **Приказна имена (`display_names`)** — опционални језички ознаке унутар JSON профила. Они превазилазе регистровано име када су присутни.
- **Застарело `display_name`** — старији JSON профили могу имати једно поље `display_name`; UI га и даље поштује када не постоји језички специфична вредност.

Када правите интеграције увек резолујте адресу на ланцу ако прихватате људски унос и проверите да ли је име слободно пре позива `setName`.

## Додатне алатке

- `setUInt` / `getUInt` огледају помоћне алате за стрингове за нумеричке метаподатке (на пример, праћење броја по домену).
- `setAll` може поставити име, аватар и показивач профила у једном позиву – корисно за скрипте за покретање.
- `removeName` и `transferName` пружају управљање животним циклусом ако је потребно одрећи се позивног имена.

Са овим примитивима можете увести додатне функције вођене профилом (значке, записе верификације, офф-чаин потврде) дефинишући нове доменске кључеве који указују на вредности на ланцу или додатне IPFS документе.